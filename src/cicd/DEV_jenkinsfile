pipeline {
    agent any
    
    stages {
        stage('Build') {
            steps {
                echo 'Building....'
                sh '''
					rm -rf target
					rm -rf gescuidoplus_frontend_sms.tar.gz
					tar czvf gescuidoplus_frontend_sms.tar.gz *
					mkdir target
					mv gescuidoplus_frontend_sms.tar.gz target/
                '''
            }
        }
        stage('Undeploy') {
            steps {
            	script {
	            	echo 'Undeploy...'
            		sh(script: "ssh jenkins@aquila.emiliollbb.net 'sudo systemctl stop gescuidoplus_frontend_sms.service'")
            		sh(script: "ssh jenkins@aquila.emiliollbb.net 'sudo rm -rf /var/lib/nodejs/nodeapps/gescuidoplus_frontend_sms'")
            	}
            }
        }
        stage('Deploy') {
            steps {
            	script {
	            	echo 'Deploy...'
	            	sh '''
	            		scp $WORKSPACE/target/gescuidoplus_frontend_sms.tar.gz jenkins@aquila.emiliollbb.net:/tmp/
						ssh jenkins@aquila.emiliollbb.net 'sudo mkdir /var/lib/nodejs/nodeapps/gescuidoplus_frontend_sms'
						ssh jenkins@aquila.emiliollbb.net 'sudo chown jenkins:jenkins /var/lib/nodejs/nodeapps/gescuidoplus_frontend_sms'
						ssh jenkins@aquila.emiliollbb.net 'tar xvf /tmp/gescuidoplus_frontend_sms.tar.gz --one-top-level=/var/lib/nodejs/nodeapps/gescuidoplus_frontend_sms'
						ssh jenkins@aquila.emiliollbb.net 'rm /tmp/gescuidoplus_frontend_sms.tar.gz'
						ssh jenkins@aquila.emiliollbb.net 'cd /var/lib/nodejs/nodeapps/gescuidoplus_frontend_sms && npm install'
						ssh jenkins@aquila.emiliollbb.net 'sudo chown -R nodejs:nodejs /var/lib/nodejs/nodeapps/gescuidoplus_frontend_sms'
						ssh jenkins@aquila.emiliollbb.net 'sudo systemctl start gescuidoplus_frontend_sms.service'
                	'''
					
	            	
	            	def status_code = 0
	            	def retries = 0
	            	while(status_code != '200' && retries < 20) {
	            		sleep(time:30,unit:"SECONDS")
	            		status_code = sh(script: "curl -sLI -w '%{http_code}' http://dev.cloudnavis.com:3000 -o /dev/null", returnStdout: true)
	            		retries++
	            		echo ('retry: ' + retries)
	            		echo status_code	
	            	}
	            	if (status_code != '200') {
					    error("Deploy failed. HTTP status: $status_code")
					}
            	}
            }
        }
    }
}
